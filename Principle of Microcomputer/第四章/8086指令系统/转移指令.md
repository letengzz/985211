# 寻址方式

​	控制转移指令在段内、段间转移时，使用[直接(相对)寻址]()或[间接寻址方式]()。 

## 直接寻址方式

### 段内直接寻址

​	目标程序和源程序在同一个程序段内，只给出源地址和目标地址的差值，此差值是偏移量，它是一个以`IP`为基准的8位或16位的带符号补码数。

### 段间直接寻址方式

​	直接给出转移目标地址的段地址和段内位移量，用前者取代`CS`当前的值，用后者取代`IP`中当前的值，使程序从一个代码段转移到另一个代码段。

## 间接寻址方式

### 段内间接寻址

​	指令转移的有效地址存在一个寄存器或存储器单元中，用它取代当前`IP`的值，实现程序转移。

### 段间间接寻址方式

​	指令给出一个存储器地址，从该地址开始的4个字节单元中存放转移目标地址的段内偏移量和段地址，这两个地址在指令执行时用于取代当前的`IP`和`CS`的内容**，**使程序从一个代码段转移到另一个代码段**。**

# 转移指令

​	通过修改指令的偏移地址或段地址及偏移地址实现程序的转移。

![image-20220525194239950](D:/Data/typora/photo/image-20220525194239950.png)

## `JMP`指令

**格式**：

​	`JMP	OP`

**功能**：无条件地将控制转移到目标地址去。

![image-20220525193708807](D:/Data/typora/photo/image-20220525193708807.png)

## 段内转移

![image-20220525193936176](D:/Data/typora/photo/image-20220525193936176.png)

### 段内转移指令

当目标地址高于源地址时称为正向转移，偏移量是正数

当目标地址低于源地址时称为反向转移，偏移量是负数


#### 段内直接短转移

​	`JMP	SHORT  OP`
​                                `IP`←`IP`+8位偏移量

#### 段内直接近转移

​	`JMP	NEAR  PTR  OP` 
​                               `IP`←`IP`+16位偏移量


#### 段内间接转移

`JMP	WORD  PTR  OP` 或 `JMP	OP`(寄存器)
                               `IP`←`EA`，`WORD PTR`是运算符

**例**：

 1. ![image-20220525195224857](D:/Data/typora/photo/image-20220525195224857.png)

 2. 段内间接寻址

    ```
      JMP	BX	;BX中16位数据为转移有效地址EA
      JMP  WORD  PTR[SI]	;以SI所指定的字单元中的16位数据为转移有效地址EA
    ```

3. 已知下列程序段，请计算其中转移指令的偏移量。

   ```
   1000∶1002H     LOOP2∶SUB   AH，23H
   1000∶1008H     JMP  SHORT   LOOP1(LOOP2)
   1000∶1020H     LOOP1∶ADD  AH，AL
   ```

   当转移指令目标地址用符号`LOOP1`表示时为正向转移，其偏移量e为正数： 
   偏移量e =`1020H`-（`1008H`+2）=`1020H`-`100AH` =`16H`             

   当转移指令目的地址用`LOOP2`表示时为反向转移，所得偏移量e为负数： 
   偏移量e =（`1002H`-（`1008H`+2[2是指令的字节数]））补码 =（-8）补码=`F8H`
   同样，已知指令的源地址和偏移量，也可以求得转移指令的目标地址。


## 段间转移

![image-20220525195845504](D:/Data/typora/photo/image-20220525195845504.png)

### 段间转移指令

#### 段间直接转移(远转移)

​	`JMP	FAR(段间转移运算符)  PTR  OP`
​												`IP`← OP的段内偏移地址
​                              				 `CS`← OP的段地址

#### 段间间接转移

​	`JMP	DWORD(双字属性运算符)  PTR  OP`
​	转移的目标段地址及偏移地址存放在内存的连续4个单元之内，前两个单元为偏移地址，后两个单元为段地址。 

**例**：

1. ![image-20220525200441809](D:/Data/typora/photo/image-20220525200441809.png)

2. 

 	`JMP	2000H:1000H`
     `JMP	FAR  PTR  NEXT`
     `JMP	DWORD  PTR  [DI]`	;用相对基址变址寻址方式找到二个字数据分别放入`IP`和`CS`中，用于确定转移地址。

## 调用和返回指令

### 调用指令

**格式**：

​	`CALL	OP`

**功能**：将`CALL`指令的下一条指令的地址(断点地址)`IP`或`IP`与`CS`压栈，新的目标地址(子程序首地址)装入`IP`或`IP`与`CS`中，控制程序转移到由`OP`指明入口的子程序。其中`OP`为子程序（过程）的名字。

**操作过程**：

1. SP-2 → SP, 当前`CS`压栈，OP所在段地址 → `CS`
2. SP-2 → SP, 当前`IP`压栈，OP的偏移地址 → `IP`
   对于段内调用只有（2）。 


**调用指令的执行过程**：

- 将调用指令的下一条指令的地址(断点)压入堆栈
- 获取子过程的入口地址(子过程第1条指令的偏移地址)
- (执行子过程，含相应参数的保存及恢复)
- 将断点偏移地址由堆栈弹出，返回原程序

**调用指令与转移指令的比较**：

- 用于调用一个子过程
- 调用前须保护断点地址
- 子过程执行结束后要返回原调用处继续执行原程序(断点恢复)

![image-20220523215647249](D:/Data/typora/photo/image-20220523215647249.png)

![image-20220523215706624](D:/Data/typora/photo/image-20220523215706624.png)

#### 段内调用

​	子过程与原调用程序在同一代码段，在调用之前只需保护断点的偏移地址
**格式**：

​	`CALL  NEAR  PROC`(近过程名)

![image-20220523220013429](D:/Data/typora/photo/image-20220523220013429.png)

#### 段间调用

​	子过程与原调用程序不在同一代码段，在调用之前需保护断点的段基地址和偏移地址。先将断点的`CS`压栈，再压入`IP`
**格式**：

​	`CALL  FAR  PROC`

**例**：

​	`CALL FAR TIMRE`

​	`CALL DWORD PTR[SI]`


### 返回指令

**格式**：

​	`RET`

**功能**：通常作为一个子程序的最后一条指令，用以返回到 调用子程序的断点处，即从堆栈弹出断点送`IP`和`CS`。

**操作过程**：   

1. 从栈顶弹出一个字给`IP`，SP+2→SP	
2. 从栈顶弹出一个字给`CS`，SP+2→SP		
   对于段内调用只有(1)。 
